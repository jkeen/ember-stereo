{"version":3,"file":"stereo-setup.js","sources":["../../src/test-support/stereo-setup.js"],"sourcesContent":["import { next } from '@ember/runloop';\nimport FakeMediaElement from './utils/fake-media-element';\nimport { _cancelTimers as cancelTimers } from '@ember/runloop';\n\n// FIX ME: this will bite someone, but webpack is not picking up and exporting sinon properly\n// with the next line included in the build, the tests will fail with an error like:\n// TypeError: sinon__WEBPACK_IMPORTED_MODULE_2___default(...).createSandbox is not a function.\n// The tests pass without that for now, so I'm proceeding.\n\n// import sinon from 'sinon'\n\nexport function stubAudio() {\n  // eslint-disable-next-line no-undef\n  let stereoSandbox = sinon.createSandbox({});\n\n  let originalCreateElement = document.createElement;\n  let createElementStub = stereoSandbox.stub(document, 'createElement');\n  createElementStub.withArgs('audio').callsFake(() => {\n    let fake = new FakeMediaElement(...arguments);\n    fake.originalCreate = originalCreateElement;\n    return fake;\n  });\n  createElementStub.withArgs('video').callsFake(() => {\n    let fake = new FakeMediaElement(...arguments);\n    fake.originalCreate = originalCreateElement;\n    return fake;\n  });\n  createElementStub.callThrough();\n\n  return stereoSandbox;\n}\n\nexport function setupStereoTest(hooks) {\n  let stereoSandbox;\n  hooks.beforeEach(async function () {\n    stereoSandbox = stubAudio();\n    this._stereoTimeout = setTimeout(() => {\n      cancelTimers();\n    }, 500);\n  });\n\n  hooks.afterEach(function () {\n    clearTimeout(this._stereoTimeout);\n\n    // Cancel any fake elements that are hanging around\n    clearTimeout(window._stereoFakeMediaElementPoller);\n    stereoSandbox.restore();\n    let stereo = this.owner.lookup('service:stereo');\n    if (stereo.isPlaying) {\n      stereo.pause();\n    }\n    stereo.destroy();\n  });\n}\n\nexport function stubConnectionCreateWithSuccess(\n  service,\n  connectionName,\n  sandbox = sinon // eslint-disable-line no-undef\n) {\n  let Connection = service.connectionLoader.get(connectionName);\n  sandbox.stub(Connection, 'canPlay').returns(true);\n\n  let stub = sandbox.stub(Connection.prototype, 'setup');\n  return stub.callsFake(function () {\n    next(() => this.trigger('audio-ready', { sound: this }));\n  });\n}\n\nexport function stubConnectionCreateWithFailure(\n  service,\n  connectionName,\n  sandbox = sinon // eslint-disable-line no-undef\n) {\n  let Connection = service.connectionLoader.get(connectionName);\n  sandbox.stub(Connection, 'canPlay').returns(true);\n  let stub = sandbox.stub(Connection.prototype, 'setup');\n  return stub.callsFake(function () {\n    next(() =>\n      this.trigger('audio-load-error', { sound: this, error: 'failed' })\n    );\n  });\n}\n"],"names":["stubAudio","stereoSandbox","sinon","createSandbox","originalCreateElement","document","createElement","createElementStub","stub","withArgs","callsFake","fake","FakeMediaElement","arguments","originalCreate","callThrough","setupStereoTest","hooks","beforeEach","_stereoTimeout","setTimeout","cancelTimers","afterEach","clearTimeout","window","_stereoFakeMediaElementPoller","restore","stereo","owner","lookup","isPlaying","pause","destroy","stubConnectionCreateWithSuccess","service","connectionName","sandbox","Connection","connectionLoader","get","returns","prototype","next","trigger","sound","stubConnectionCreateWithFailure","error"],"mappings":"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"}