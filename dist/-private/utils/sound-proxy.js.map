{"version":3,"file":"sound-proxy.js","sources":["../../../src/-private/utils/sound-proxy.js"],"sourcesContent":["import { tracked } from '@glimmer/tracking';\nimport { isEmpty } from '@ember/utils';\nimport debug from 'debug';\nimport Evented from './evented';\nimport hasEqualUrls from './has-equal-urls';\nimport { task, waitForProperty, didCancel } from 'ember-concurrency';\nimport { registerDestructor } from '@ember/destroyable';\n/**\n* This class lazy loads sounds based on identifiers\n  @private\n  @class SoundProxy\n*/\n\nexport default class SoundProxy extends Evented {\n  @tracked isLoading = false;\n  @tracked identifier;\n\n  constructor(identifier, stereo) {\n    super(...arguments);\n\n    this.stereo = stereo;\n    this.stereo.on('loadTask:started', this.onStart.bind(this));\n    this.stereo.on('loadTask:errored', this.onFinish.bind(this));\n    this.stereo.on('loadTask:succeeded', this.onFinish.bind(this));\n\n    registerDestructor(this, this.willDestroy.bind(this));\n\n    this.resolveUrlTask.perform(identifier).catch((e) => {\n      if (!didCancel(e)) {\n        throw e;\n      }\n    });\n\n    this.waitForLoadTask.perform().catch((e) => {\n      if (!didCancel(e)) {\n        throw e;\n      }\n    });\n  }\n\n  @tracked value;\n\n  @task({ debug: true })\n  *waitForLoadTask() {\n    yield waitForProperty(this, 'identifier', (v) => !!v);\n    debug('ember-stereo:sound-proxy')(`waiting for ${this.identifier} to load`);\n\n    this.value = this.stereo.findLoadedSound(this.identifier);\n\n    yield waitForProperty(this, 'value', (v) => !!v);\n    debug('ember-stereo:sound-proxy')(\n      `the wait is over for ${this.identifier} to load`\n    );\n  }\n\n  async afterLoad(callback) {\n    try {\n      await this.waitForLoadTask.perform();\n      callback(this.value);\n    } catch (e) {\n      // no-op\n    }\n  }\n\n  @task\n  *resolveUrlTask(identifier) {\n    this.identifier = yield this.stereo.resolveIdentifierTask.perform(\n      identifier\n    );\n    debug('ember-stereo:sound-proxy')(\n      `resolved identifier to ${this.identifier}`\n    );\n  }\n\n  get isPending() {\n    return !this.value;\n  }\n\n  get isResolved() {\n    return !isEmpty(this.value);\n  }\n\n  get isErrored() {\n    return !isEmpty(this.errors);\n  }\n\n  get errors() {\n    return this.stereo.cachedErrors.find((error) =>\n      hasEqualUrls(error.url, this.identifier)\n    );\n  }\n\n  async onStart(taskInstance) {\n    let urls = await this.stereo.resolveIdentifierTask.perform(\n      taskInstance.args[0]\n    );\n\n    let match = hasEqualUrls(urls, this.identifier);\n    if (match) {\n      this.isLoading = true;\n    }\n  }\n\n  async onFinish(taskInstance) {\n    let urls = await this.stereo.resolveIdentifierTask.perform(\n      taskInstance.args[0]\n    );\n    let match = hasEqualUrls(urls, this.identifier);\n    if (match) {\n      this.isLoading = false;\n      this.value = this.stereo.findLoadedSound(this.identifier);\n    }\n  }\n\n  willDestroy() {\n    this.stereo.off('loadTask:started', this.onStart.bind(this));\n    this.stereo.off('loadTask:errored', this.onFinish.bind(this));\n    this.stereo.off('loadTask:succeeded', this.onFinish.bind(this));\n  }\n}\n"],"names":["SoundProxy","_dec","task","debug","_class","Evented","constructor","identifier","stereo","arguments","_initializerDefineProperty","_descriptor","_descriptor2","_descriptor3","on","onStart","bind","onFinish","registerDestructor","willDestroy","resolveUrlTask","perform","catch","e","didCancel","waitForLoadTask","waitForProperty","v","value","findLoadedSound","afterLoad","callback","resolveIdentifierTask","isPending","isResolved","isEmpty","isErrored","errors","cachedErrors","find","error","hasEqualUrls","url","taskInstance","urls","args","match","isLoading","off","_applyDecoratedDescriptor","prototype","tracked","configurable","enumerable","writable","initializer","Object","getOwnPropertyDescriptor"],"mappings":"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"}